<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wroclaw Public Transport Finder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        #controls {
            padding: 12px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        label {
            margin-right: 10px;
        }

        #results {
            padding: 12px;
        }

        .result-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 8px;
        }

        .marker-label {
            font-size: 14px;
            font-weight: bold;
        }
    </style>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div id="controls">
    <label>Departure time:
        <input type="datetime-local" id="departureTime">
    </label>

    <label>Limit:
        <input type="number" id="limit" value="5" min="1" max="20">
    </label>

    <button id="fetchBtn">Find nearest departures</button>

    <p>Select Start and Destination points by clicking on the map.</p>
    <p>Current: 
        <span id="startDisp">Start: not set</span> | 
        <span id="destDisp">Destination: not set</span>
    </p>
</div>

<div id="map"></div>

<div id="results"></div>

<script>
    let startMarker = null;
    let destMarker = null;
    let startCoords = null;
    let destCoords = null;

    const startDisp = document.getElementById("startDisp");
    const destDisp = document.getElementById("destDisp");
    const resultsDiv = document.getElementById("results");

    const map = L.map('map').setView([51.1079, 17.0385], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    let selectionMode = "start"; // Alternate between selecting start/destination

    map.on("click", function (e) {
        const { lat, lng } = e.latlng;

        if (selectionMode === "start") {
            if (startMarker) map.removeLayer(startMarker);
            startMarker = L.marker([lat, lng], { draggable: false }).addTo(map)
                .bindPopup("Start Point").openPopup();
            startCoords = `${lat},${lng}`;
            startDisp.textContent = `Start: ${startCoords}`;
            selectionMode = "dest";
        } else {
            if (destMarker) map.removeLayer(destMarker);
            destMarker = L.marker([lat, lng], { draggable: false }).addTo(map)
                .bindPopup("Destination").openPopup();
            destCoords = `${lat},${lng}`;
            destDisp.textContent = `Destination: ${destCoords}`;
            selectionMode = "start";
        }
    });

    document.getElementById("fetchBtn").addEventListener("click", async () => {
        if (!startCoords || !destCoords) {
            alert("Please select both start and destination points.");
            return;
        }

        const departureInput = document.getElementById("departureTime").value;
        let startTimeIso;

        if (departureInput) {
            startTimeIso = new Date(departureInput).toISOString();
        } else {
            startTimeIso = new Date().toISOString();
        }

        const limit = document.getElementById("limit").value;

        const url =
            `http://localhost:5001/public_transport/city/Wroclaw/closest_departures`
            + `?start_coordinates=${startCoords}`
            + `&end_coordinates=${destCoords}`
            + `&start_time=${startTimeIso}`
            + `&limit=${limit}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            resultsDiv.innerHTML = "";

            if (!data.departures || data.departures.length === 0) {
                resultsDiv.innerHTML = "<p>No departures found.</p>";
                return;
            }

            data.departures.forEach(dep => {
                const item = document.createElement("div");
                item.className = "result-item";

                const stop = dep.stop;

                item.innerHTML =
                    `Stop: <b>${stop.name}</b><br>` +
                    `Line: ${dep.route_id}<br>` +
                    `Destination: ${dep.trip_headsign}<br>` +
                    `Departure: ${stop.departure_time}`;

                resultsDiv.appendChild(item);

                // Optional: Add marker for the stop
                L.circleMarker([stop.coordinates.latitude, stop.coordinates.longitude], {
                    radius: 6,
                    color: "blue"
                }).addTo(map)
                    .bindPopup(`<b>${stop.name}</b><br>${dep.route_id} â†’ ${dep.trip_headsign}`);
            });

        } catch (err) {
            console.error(err);
            alert("Error while contacting backend.");
        }
    });
</script>

</body>
</html>

